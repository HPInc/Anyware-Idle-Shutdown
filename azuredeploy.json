{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "domainName": {
      "type": "string",
      "metadata": {
        "description": "The FQDN of the Active Directory Domain to be created. Must have a '.' like domain.local"
      }
    },
    "domainGroupToJoin": {
      "type": "string",
      "defaultValue": "Remote Workstations",
      "metadata": {
        "description": "The domain Group name which pcoip virtual machines join"
      }
    },
    "serviceAccountName": {
      "type": "string",
      "metadata": {
        "description": "The name of the service account that join computers to domain"
      }
    },
    "serviceAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the service account"
      }
    },
    "subVnetId": {
      "type": "string",
      "metadata": {
        "description": "the Id of the sub virtual network which CAM VM resides"
      }
    },
    "cmIPAddresses": {
      "type": "array",
      "minLength": 2,
      "metadata": {
        "description": "two IP addresses which used by CAM Connect Manager. Those two ipaddress should be within the range of the provided subVnet address space"
      }
    },
    "localAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name of the local Virtual Machine adminstrator"
      }
    },
    "localAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password of the local virtual machine adminstrator"
      }
    },
    "AzureAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name of the Azure account/service principal with contributor access to the subscription. This account cannot require MFA."
      }
    },
    "AzureAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password of the Azure account/service principal with contributor access to the subscription. This account cannot require MFA."
      }
    },
    "tenantID": {
      "type": "string",
      "defaultValue": "null",
      "metadata": {
        "description": "Tenant ID to use for the case where the Azure Admin account is a service principal. Leave as 'null' if a standard user (non-SP) account is being used."
      }
    },
    "registrationCode": {
      "type": "securestring",
      "minLength": 21,
      "metadata": {
        "description": "PCoIP Agent License Registration Code."
      }
    },
    "CAMDeploymentBlobSource": {
      "type": "string",
      "defaultValue": "https://teradeploy.blob.core.windows.net/binaries",
      "metadata": {
        "description": "The location of the blobs for admin GUI machine installation"
      }
    },
    "_artifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "The location of resources, such as templates and DSC modules, that the template depends on"
      },
      "defaultValue": "https://raw.githubusercontent.com/teradici/deploy/master"
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "metadata": {
        "description": "Auto-generated token to access _artifactsLocation"
      },
      "defaultValue": ""
    },
    "camSaasUri": {
      "type": "string",
      "metadata": {
        "description": "URI for the CAM SAAS"
      },
      "defaultValue": "https://cam-antar.teradici.com"
    },
    "verifyCAMSaaSCertificate": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "a flag to indicate whether to verify CAM SaaS Server certificate. True means to verify."
      }
    }
  },
  "variables": {
    "templateStorageAccountName": "[concat(uniquestring(resourceGroup().id), 'data')]",
    "domainGroupAppServersJoin": "[parameters('domainGroupToJoin')]",
    "adminDesktopVMName": "admin-rws",
    "vnetId": "[first(split(parameters('subVnetId'), '/subnets/'))]",
    "adSubnetName": "[last(split(parameters('subVnetId'), '/subnets/'))]",    
    "gwSubnetName": "[variables('adSubnetName')]",
    "cmnsgName": "cmNSG"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('templateStorageAccountName')]",
      "apiVersion": "2016-01-01",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "Storage",
      "properties": {}
    },

    {
      "type": "Microsoft.Resources/deployments",
      "name": "Frontend",
      "apiVersion": "2016-02-01",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('templateStorageAccountName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/frontend/azuredeploy.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {

          "virtualNetworkName": {
            "value": "[variables('vnetId')]"
          },
          "adSubnetName": {
            "value": "[variables('adSubnetName')]"
          },
          "gatewaySubnetName": {
            "value": "[variables('gwSubnetName')]"
          },
          "cmIPAddresses": {
            "value": "[parameters('cmIPAddresses')]"
          },
          "adminDesktopVMName": {
            "value": "[variables('adminDesktopVMName')]"
          },
          "cmnsgName": {
            "value": "[variables('cmnsgName')]"
          },
          "domainName": {
            "value": "[parameters('domainName')]"
          },
          "domainGroupToJoin": {
            "value": "[variables('domainGroupAppServersJoin')]"
          },
          "domainAdminUsername": {
            "value": "[parameters('serviceAccountName')]"
          },
          "domainAdminPassword": {
            "value": "[parameters('serviceAccountPassword')]"
          },
          "localAdminUsername": {
            "value": "[parameters('localAdminUsername')]"
          },
          "localAdminPassword": {
            "value": "[parameters('localAdminPassword')]"
          },
          "AzureAdminUsername": {
            "value": "[parameters('AzureAdminUsername')]"
          },
          "AzureAdminPassword": {
            "value": "[parameters('AzureAdminPassword')]"
          },
          "tenantID": {
            "value": "[parameters('tenantID')]"
          },
          "registrationCode": {
            "value": "[parameters('registrationCode')]"
          },
          "camSaasUri": {
            "value": "[parameters('camSaasUri')]"
          },
          "userDataStorageAccount": {
            "value": "[variables('templateStorageAccountName')]"
          },
          "verifyCAMSaaSCertificate": {
            "value": "[parameters('verifyCAMSaaSCertificate')]"
          },
          "CAMDeploymentBlobSource": {
            "value": "[parameters('CAMDeploymentBlobSource')]"
          },
          "_agentArtifactsLocation": {
            "value": "[concat(parameters('_artifactsLocation'), '/end-user-application-machines/new-agent-vm')]"
          },
          "_artifactsLocation": {
            "value": "[concat(parameters('_artifactsLocation'), '/frontend')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "name": "CreateEndUserApplicationMachine",
      "apiVersion": "2016-02-01",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('templateStorageAccountName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/end-user-application-machines/azuredeploy.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "existingVNETName": {
            "value": "[parameters('vnetId')]"
          },
          "existingSubnetName": {
            "value": "[variables('adSubnetName')]"
          },
          "dnsLabelPrefix": {
            "value": "[variables('adminDesktopVMName')]"
          },
          "vmSize": {
            "value": "Standard_D2_v2"
          },
          "domainToJoin": {
            "value": "[parameters('domainName')]"
          },
          "domainUsername": {
            "value": "[parameters('serviceAccountName')]"
          },
          "domainPassword": {
            "value": "[parameters('serviceAccountPassword')]"
          },
          "domainJoinOptions": {
            "value": 3
          },
          "vmAdminUsername": {
            "value": "[parameters('localAdminUsername')]"
          },
          "vmAdminPassword": {
            "value": "[parameters('localAdminPassword')]"
          },
          "domainGroupToJoin": {
            "value": "[variables('domainGroupAppServersJoin')]"
          },
          "_artifactsLocation": {
            "value": "[concat(parameters('_artifactsLocation'), '/end-user-application-machines')]"
          },
          "CAMDeploymentBlobSource": {
            "value": "[parameters('CAMDeploymentBlobSource')]"
          },
          "binaryLocation": {
            "value": "[parameters('CAMDeploymentBlobSource')]"
          },
          "registrationCode": {
            "value": "[parameters('registrationCode')]"
          }
        }
      }
    }
  ]
}
