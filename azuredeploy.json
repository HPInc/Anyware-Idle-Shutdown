{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "domainAdminUsername": {
      "type": "string",
      "defaultValue": "adminUser",
      "metadata": {
        "description": "The name of the administrator account of the new VM and domain"
      }
    },
    "domainAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the administrator account of the new VM and domain"
      }
    },
    "domainName": {
      "type": "string",
      "defaultValue": "example.com",
      "metadata": {
        "description": "The FQDN of the Active Directory Domain to be created. Must have a '.' like domain.local"
      }
    },
    "localAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name of the local admin account for connection service VM's"
      }
    },
    "localAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password/key for the local VM accounts."
      }
    },
    "rwsLocalAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name of the local admin account for remote workstation VM's"
      }
    },
    "rwsLocalAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password/key for the local remote workstation accounts."
      }
    },
    "registrationCode": {
      "type": "securestring",
      "minLength": 21,
      "metadata": {
        "description": "PCoIP Agent License Registration Code."
      }
    },
    "certData": {
      "type": "string",
      "metadata": {
        "description": "Base-64 encoded form of the .pfx file for the Application Gateway Certificate"
      }
    },
    "certPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for .pfx certificate"
      }
    },
    "CAMDeploymentInfo": {
      "type": "securestring",
      "metadata": {
          "description": "Encoded blob of authorization and URL information for the CAM Connection Service."
      }
    },
    "CAMDeploymentBlobSource": {
      "type": "string",
      "defaultValue": "https://teradeploy.blob.core.windows.net/binaries",
      "metadata": {
        "description": "The location of the blobs for admin GUI machine installation"
      }
    },
    "_artifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "The location of resources, such as templates and DSC modules, that the template depends on"
      },
      "defaultValue": "https://raw.githubusercontent.com/teradici/deploy/master"
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "metadata": {
        "description": "Auto-generated token to access _artifactsLocation"
      },
      "defaultValue": ""
    }
  },
  "variables": {
    "domainGroupAppServersJoin": "Remote Workstations",
    "adminDesktopVMName": "admin-rws"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "name": "Root",
      "apiVersion": "2016-02-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/root/azuredeploy.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "domainName": {
            "value": "[parameters('domainName')]"
          },
          "domainAdminUsername": {
            "value": "[parameters('domainAdminUsername')]"
          },
          "domainAdminPassword": {
            "value": "[parameters('domainAdminPassword')]"
          },
          "CAMDeploymentBlobSource": {
            "value": "[parameters('CAMDeploymentBlobSource')]"
          },
          "_artifactsLocation": {
            "value": "[concat(parameters('_artifactsLocation'), '/root')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },

    {
      "type": "Microsoft.Resources/deployments",
      "name": "ConnectionService",
      "apiVersion": "2016-02-01",
      "dependsOn": [
        "Root"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/connection-service/azuredeploy.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "CSsubnetId": {
            "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', reference('Root').outputs.virtualNetworkName.value, reference('Root').outputs.adSubnetName.value)]"
          },
          "GWsubnetId": {
            "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', reference('Root').outputs.virtualNetworkName.value, reference('Root').outputs.gatewaySubnetName.value)]"
          },
          "domainName": {
            "value": "[parameters('domainName')]"
          },
          "domainAdminUsername": {
            "value": "[parameters('domainAdminUsername')]"
          },
          "domainAdminPassword": {
            "value": "[parameters('domainAdminPassword')]"
          },
          "domainGroupAppServersJoin": {
            "value": "[variables('domainGroupAppServersJoin')]"
          },
          "localAdminUsername": {
            "value": "[parameters('localAdminUsername')]"
          },
          "localAdminPassword": {
            "value": "[parameters('localAdminPassword')]"
          },
          "certData": {
            "value": "[parameters('certData')]"
          },
          "certPassword": {
            "value": "[parameters('certPassword')]"
          },
          "CAMDeploymentInfo": {
            "value": "[parameters('CAMDeploymentInfo')]"
          },
          "CAMDeploymentBlobSource": {
            "value": "[parameters('CAMDeploymentBlobSource')]"
          },
          "_artifactsLocation": {
            "value": "[concat(parameters('_artifactsLocation'), '/connection-service')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "name": "CreateEndUserApplicationMachine",
      "apiVersion": "2016-02-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/Root"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/remote-workstations/azuredeploy.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "subnetId": {
            "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', reference('Root').outputs.virtualNetworkName.value, reference('Root').outputs.rwSubnetName.value)]"
          },
          "dnsLabelPrefix": {
            "value" : "[variables('adminDesktopVMName')]"
          },
          "vmSize": {
            "value": "Standard_D2_v2"
          },
          "domainToJoin": {
            "value": "[parameters('domainName')]"
          },
          "domainUsername": {
            "value": "[parameters('domainAdminUsername')]"
          },
          "domainPassword": {
            "value": "[parameters('domainAdminPassword')]"
          },
          "domainJoinOptions": {
            "value": 3
          },
          "vmAdminUsername": {
            "value": "[parameters('rwsLocalAdminUsername')]"
          },
          "vmAdminPassword": {
            "value": "[parameters('rwsLocalAdminPassword')]"
          },
          "domainGroupToJoin": {
            "value": "[variables('domainGroupAppServersJoin')]"
          },
          "CAMDeploymentInfo": {
            "value": "[parameters('CAMDeploymentInfo')]"
          },
          "registrationCode": {
            "value": "[parameters('registrationCode')]"
          },
          "_artifactsLocation": {
            "value": "[concat(parameters('_artifactsLocation'), '/remote-workstations')]"
          },
          "CAMDeploymentBlobSource": {
            "value": "[parameters('CAMDeploymentBlobSource')]"
          },
          "binaryLocation": {
            "value": "[parameters('CAMDeploymentBlobSource')]"
          }
        }
      }
    }
  ]
}
