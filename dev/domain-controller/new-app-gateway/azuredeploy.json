{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "subnetRef": {
            "type": "string",
            "metadata": {
                "description": "Subnet resource reference in the form of (vnet resourceId/subnets/(subnetname))"
            }
        },
        "skuName": {
            "type": "string",
            "allowedValues": [
                "Standard_Small",
                "Standard_Medium",
                "Standard_Large"
            ],
            "defaultValue": "Standard_Medium",
            "metadata": {
                "description": "Sku Name"
            }
        },
        "capacity": {
            "type": "int",
            "minValue": 1,
            "maxValue": 10,
            "defaultValue": 2,
            "metadata": {
                "description": "Number of instances"
            }
        },
        "backendIpAddressDefault": {
            "type": "string",
            "metadata": {
                "description": "IP Address of Default Backend Server"
            }
        },
        "backendIpAddressForPathRule1": {
            "type": "string",
            "metadata": {
                "description": "IP Address of Backend Server for Path Rule 1 match"
            }
        },
        "pathMatch1": {
            "type": "string",
            "metadata": {
                "description": "Path match string for Path Rule 1"
            }
        },
        "certData": {
            "type": "string",
            "metadata": {
                "description": "Base-64 encoded form of the .pfx file"
            },
            "defaultValue": "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"
        },
        "certPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for .pfx certificate"
            },
            "defaultValue": "changeit"
        }
    },
    "variables": {
        "applicationGatewayName": "applicationGateway1",
        "publicIPAddressName": "publicIp1",
        "virtualNetworkName": "virtualNetwork1",
        "publicIPRef": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]",
        "applicationGatewayID": "[resourceId('Microsoft.Network/applicationGateways',variables('applicationGatewayName'))]",
    "apiVersion": "2015-06-15"
    },
  "resources": [
    {
      "apiVersion": "[variables('apiVersion')]",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "Dynamic"
      }
    },
    {
      "apiVersion": "[variables('apiVersion')]",
      "name": "[variables('applicationGatewayName')]",
      "type": "Microsoft.Network/applicationGateways",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
      ],
      "properties": {
        "sku": {
          "name": "[parameters('skuName')]",
          "tier": "Standard",
          "capacity": "[parameters('capacity')]"
        },
        "sslCertificates": [
          {
            "name": "appGatewaySslCert",
            "properties": {
              "data": "[parameters('certData')]",
              "password": "[parameters('certPassword')]"
            }
          }
        ],
        "gatewayIPConfigurations": [
          {
            "name": "appGatewayIpConfig",
            "properties": {
              "subnet": {
                "id": "[parameters('subnetRef')]"
              }
            }
          }
        ],
        "frontendIPConfigurations": [
          {
            "name": "appGatewayFrontendIP",
            "properties": {
              "PublicIPAddress": {
                "id": "[variables('publicIPRef')]"
              }
            }
          }
        ],
        "frontendPorts": [
          {
            "name": "appGatewayFrontendPort",
            "properties": {
              "Port": 443
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "appGatewayBackendPoolDefault",
            "properties": {
              "BackendAddresses": [
                {
                  "IpAddress": "[parameters('backendIpAddressDefault')]"
                }
              ]
            }
        },
        {
            "name": "appGatewayBackendPool1",
            "properties": {
              "BackendAddresses": [
                {
                  "IpAddress": "[parameters('backendIpAddressForPathRule1')]"
                }
              ]
            }
          },
          {
            "name": "appGatewayBackendPool2",
            "properties": {
              "BackendAddresses": [
                {
                  "IpAddress": "[parameters('backendIpAddressForPathRule2')]"
                }
              ]
            }
          }
        ],
        "backendHttpSettingsCollection": [
          {
            "name": "appGatewayBackendHttpSettings",
            "properties": {
              "Port": 8080,
              "Protocol": "Http",
              "CookieBasedAffinity": "Enabled"
            }
          }
        ],
        "httpListeners": [
          {
            "name": "appGatewayHttpListener",
            "properties": {
              "FrontendIPConfiguration": {
                "Id": "[concat(variables('applicationGatewayID'), '/frontendIPConfigurations/appGatewayFrontendIP')]"
              },
              "FrontendPort": {
                "Id": "[concat(variables('applicationGatewayID'), '/frontendPorts/appGatewayFrontendPort')]"
              },
              "Protocol": "Https",
              "SslCertificate": {
                "Id": "[concat(variables('applicationGatewayID'), '/sslCertificates/appGatewaySslCert')]"
              }
            }
          }
        ],
        "urlPathMaps": [
          {
            "name": "urlPathMap1",
            "properties": {
              "defaultBackendAddressPool": {
                "id": "[concat(variables('applicationGatewayID'), '/backendAddressPools/appGatewayBackendPoolDefault')]"
              },
              "defaultBackendHttpSettings": {
                "id": "[concat(variables('applicationGatewayID'), '/backendHttpSettingsCollection/appGatewayBackendHttpSettings')]"
              },
              "pathRules": [
                {
                  "name": "pathRule1",
                  "properties": {
                    "paths": [
                      "[parameters('pathMatch1')]"
                    ],
                    "backendAddressPool": {
                      "id": "[concat(variables('applicationGatewayID'), '/backendAddressPools/appGatewayBackendPool1')]"
                    },
                    "backendHttpSettings": {
                      "id": "[concat(variables('applicationGatewayID'), '/backendHttpSettingsCollection/appGatewayBackendHttpSettings')]"
                    }
                  }
                },
                {
                  "name": "pathRule2",
                  "properties": {
                    "paths": [
                      "[parameters('pathMatch2')]"
                    ],
                    "backendAddressPool": {
                      "id": "[concat(variables('applicationGatewayID'), '/backendAddressPools/appGatewayBackendPool2')]"
                    },
                    "backendHttpSettings": {
                      "id": "[concat(variables('applicationGatewayID'), '/backendHttpSettingsCollection/appGatewayBackendHttpSettings')]"
                    }
                  }
                }
              ]
            }
          }
        ],
        "requestRoutingRules": [
          {
            "Name": "rule1",
            "properties": {
              "RuleType": "PathBasedRouting",
              "httpListener": {
                "id": "[concat(variables('applicationGatewayID'), '/httpListeners/appGatewayHttpListener')]"
              },
              "urlPathMap": {
                "id": "[concat(variables('applicationGatewayID'), '/urlPathMaps/urlPathMap1')]"
              }
            }
          }
        ]
      }
    }
  ]
}
